<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenStreetMap with Multiple Markers</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        #map {
            height: 100vh;
            width: 100vw;
        }

        h1 {
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Initialize the map
        const map = L.map('map', {
            center: [22.362891, 114.050456],
            zoom: 14,
        });

        // Function to get URL parameters
        function getParameterByName(name) {
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(window.location.href);
            return results ? (results[2] ? decodeURIComponent(results[2].replace(/\+/g, ' ')) : '') : null;
        }

        // Get parameters
        const dataParam = getParameterByName('data');
        const typeParam = getParameterByName('type') || ''; // Make type optional
        const tileParam = getParameterByName('tile') || "default";
        const itemsParam = getParameterByName('items') || '';
        const isSpy = typeParam === 'spy';

        // Tile layer selection
        const tileOptions = {
            cartocdn: {
                url: "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",
                maxZoom: 24,
            },
            osm: {
                url: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                maxZoom: 24,
            },
            default: {
                url: "https://2.aerial.maps.ls.hereapi.com/maptile/2.1/maptile/newest/satellite.day/{z}/{x}/{y}/256/png8?app_id=eAdkWGYRoc4RfxVo0Z4B&app_code=TrLJuXVK62IQk0vuXFzaig&lg=eng",
                maxZoom: 20,
            }
        };

        const selectedTile = tileOptions[tileParam] || tileOptions.default;

        // Add tile layer to the map
        L.tileLayer(selectedTile.url, { maxZoom: selectedTile.maxZoom }).addTo(map);

        // Function to create markers
        const createMarker = (lat, lon, iconUrl) => {
            return L.marker([lat, lon], {
                icon: L.icon({
                    iconUrl: iconUrl,
                    iconSize: [30, 30],
                })
            });
        };

        if (dataParam) {
            try {
                const jData = dataParam.split('@').map(Number);
                if (jData.length % 2 !== 0) throw new Error("Invalid number of coordinates");

                const jsonData = [];
                for (let i = 0; i < jData.length; i += 2) {
                    jsonData.push({ lat: jData[i], lon: jData[i + 1] });
                }

                let itemList = itemsParam ? itemsParam.split('@') : [];
                const iconUrls = {
                    user: 'https://raw.githubusercontent.com/Mcc-Mak/bb95.group-game.github.io/refs/heads/main/UserPosition.png',
                    treasure: (level) => `https://raw.githubusercontent.com/Mcc-Mak/bb95.group-game.github.io/refs/heads/main/TreasureBox-Lv${level}.jpg`,
                    key: 'https://raw.githubusercontent.com/Mcc-Mak/bb95.group-game.github.io/refs/heads/main/Key.png',
					item: `https://raw.githubusercontent.com/Mcc-Mak/bb95.group-game.github.io/refs/heads/main/TreasurePosition.png`,
					opponent: `https://raw.githubusercontent.com/Mcc-Mak/bb95.group-game.github.io/refs/heads/main/ShadowPosition.png`,
                };

                jsonData.forEach(({ lat, lon }, i) => {
                    let markerType, iconUrl;

                    if (i === 0) {
                        markerType = 'user';
                        iconUrl = iconUrls.user;
                    } else {
                        markerType = 'treasure';
						if(!isSpy) {
							if(itemList.length > 0) {
								if (itemList[i - 1] === "KEY_1") {
									iconUrl = iconUrls.key;
								} else if (itemList[i - 1] === "ITEM_1") {
									iconUrl = iconUrls.treasure(1);
								} else if (itemList[i - 1] === "ITEM_2") {
									iconUrl = iconUrls.treasure(2);
								}
							} else {
								iconUrl = iconUrls.item;
							}
						} else {
							iconUrl = iconUrls.opponent;
						}
                    }
					console.log(i, markerType, iconUrl, itemList)
                    
                    const marker = createMarker(lat, lon, iconUrl);
                    marker.addTo(map);

                    if (i !== 0) {
                        let distance = (
                            (
                                (
                                    jsonData[0].lat - lat
                                ) ** 2 + (
                                    jsonData[0].lon - lon
                                ) ** 2
                            ) ** 0.5
                        ) * 100 * 1000;
                        let popup = L.popup().setContent(`
                            <span style="font-weight:bold">Distance: </span><span style="color:red;font-weight:italic">${distance.toFixed(3)} m</span>
                        `);
                        marker.bindPopup(popup);
                    }
                    marker.on("click", () => map.setView([lat, lon], 20));
                });

                // Adjust view to fit all markers
                const bounds = jsonData.map(({ lat, lon }) => [lat, lon]);
                map.fitBounds(bounds);
                map.invalidateSize();
                document.querySelector('.leaflet-control-attribution').innerHTML = "";
            } catch (error) {
                console.error('Error parsing data parameter:', error);
                alert('Invalid data format. Please provide valid coordinates.');
            }
        } else {
            alert('No data parameter provided.');
        }
    </script>

</body>

</html>
